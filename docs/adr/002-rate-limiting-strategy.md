# ADR-002: Стратегия ограничения частоты запросов (Rate Limiting)

- **Status:** Accepted
- **Date:** 2026-02-14
- **Author:** Backend Team
- **Context:**
  Перед внедрением модуля авторизации необходимо защитить API от автоматизированных атак (Brute Force), DDoS-активности и несанкционированного парсинга контента (Scraping). Современные SPA (Single Page Applications) на базе Next.js/React генерируют значительный объем трафика из-за функций prefetching, параллельной загрузки данных и частых переходов, что требует гибкой настройки лимитов для предотвращения ложноположительных срабатываний у реальных пользователей.

- **Decision:**
  Мы принимаем **многоуровневую стратегию лимитирования** (Burst, Sustained, Anti-Scraping), реализованную через `@nestjs/throttler`.

    Установлены следующие параметры:
    1.  **Short (Burst Protection): 10 запросов / 1 сек**
        - _Rationale:_ Современные браузеры и HTTP/2 позволяют отправлять множество параллельных запросов при загрузке страницы. Лимит в 10 ед/сек позволяет избежать блокировки при инициализации приложения или пакетной отправке метаданных.
    2.  **Medium (Active User Protection): 300 запросов / 1 мин**
        - _Rationale:_ При активном использовании каталога животных (бесконечный скроллинг, открытие галерей, фильтрация) пользователь может совершать сотни запросов в минуту. 300 запросов обеспечивают "запас прочности" для любого легитимного сценария использования интерфейса.
    3.  **Long (Anti-Scraping): 5000 запросов / 1 час**
        - _Rationale:_ Лимит в 5000 запросов в час практически недостижим для человека (в среднем >1 запроса в секунду непрерывно), но эффективно останавливает автоматические скрипты, пытающиеся выкачать всю базу данных или перебрать эндпоинты.

- **Consequences:**
    - **Positive:**
        - Высокая защита от DDoS и Brute Force на раннем этапе (до Auth).
        - Отсутствие негативного влияния на User Experience (UX) при активном скроллинге.
        - Четкое разграничение между "человеческим" и "роботизированным" трафиком.
    - **Negative:**
        - Необходимость учитывать лимиты при написании автоматизированных E2E тестов (понадобится механизм исключения для тестовых IP).
        - Дополнительная нагрузка на хранилище состояний (память/Redis).

- **Compliance:**
    - Глобальный `ThrottlerGuard` должен быть активен для всех эндпоинтов, кроме специфических исключений (например, Webhooks от платежных систем).
    - При превышении лимитов API обязан возвращать стандартный статус `429 Too Many Requests`.
