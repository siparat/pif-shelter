# ADR-001: Hybrid Repository Pattern (CQRS)

* **Status:** Accepted
* **Date:** 2026-02-05
* **Author:** Backend Team
* **Context:**
    При реализации Clean Architecture и CQRS существует дилемма доступа к данным.
    Классический подход требует использовать Репозитории (Repositories) для всего, чтобы полностью скрыть базу данных от Application Layer.
    Однако, для операций чтения (Queries), которые часто требуют сложных JOIN-ов, агрегаций и фильтрации для UI, использование Репозиториев приводит к проблемам:
    1.  N+1 проблема при маппинге Entity.
    2.  Лишний оверхед на конвертацию: DB Record -> Domain Entity -> DTO.
    3.  Потеря возможностей ORM/SQL (Drizzle) при построении сложных динамических фильтров.

* **Decision:**
    Мы принимаем **Гибридный подход** разделения ответственности:

    1.  **Write Side (Commands):**
        * Используем строгий **Repository Pattern**.
        * Хендлеры работают только с Domain Entities и Ports.
        * Прямой доступ к Drizzle запрещен.
        * *Причина:* Здесь важна инкапсуляция бизнес-правил и целостность агрегатов.

    2.  **Read Side (Queries):**
        * Отказываемся от репозиториев.
        * Query Handlers имеют право инжектить `DrizzleService` напрямую.
        * Запросы возвращают сразу готовые DTO (Projections), минуя Domain Entities.
        * *Причина:* Для чтения важна производительность и гибкость выборки. Чтение не меняет состояние системы, поэтому инварианты домена здесь проверять не нужно.

* **Consequences:**
    * **Positive:**
        * Уменьшение количества boilerplate-кода (не нужно писать методы `findAllByFilter` в репозиториях).
        * Повышение производительности на чтение (отсутствие двойного маппинга).
        * Возможность использовать всю мощь SQL/Drizzle в Query Handlers.
    * **Negative:**
        * Слой Application (в части Queries) становится жестко связан с Drizzle ORM.
        * Если мы захотим сменить базу данных, придется переписывать все Query Handlers (риск принят, так как смена БД маловероятна).

* **Compliance:**
    * Код-ревьюверы должны отклонять PR, где в CommandHandler используется прямой `db.select()`.
    * Код-ревьюверы должны отклонять PR, где в QueryHandler происходит `db.insert/update`.