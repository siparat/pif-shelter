# ADR-005: Стратегия масштабируемой загрузки медиа-файлов

- **Status:** Accepted
- **Date:** 2026-02-19
- **Author:** Backend Team / Senior Architect
- **Context:**
  Приложению требуется функционал загрузки изображений (аватарки пользователей, фотографии животных). Классическая загрузка через API (Multipart/form-data) создает избыточную нагрузку на CPU сервера (сжатие) и RAM (буферизация файлов), а также увеличивает стоимость трафика. При масштабировании это становится узким местом.

- **Decision:**
  Мы принимаем стратегию **Direct-to-S3 Upload** с предобработкой на стороне клиента:
    1.  **Обработка изображений (Client-side Processing):**
        - Клиент (Frontend) самостоятельно конвертирует изображения в формат `.webp`.
        - Клиент применяет сжатие (quality: 80%) и изменение размера (resize) перед отправкой.
        - _Причина:_ Снятие нагрузки с бэкенда и экономия ресурсов облачных функций (Lambda). Современные браузеры эффективно справляются с этой задачей.

    2.  **Загрузка (Pre-signed POST):**
        - API не принимает файлы. API выдает временную ссылку (Pre-signed POST URL) с жесткими ограничениями.
        - Клиент загружает файл напрямую в S3 бакет.
        - _Безопасность:_ Ссылка содержит `Conditions` (лимит размера файла до 2МБ, проверка `Content-Type: image/webp`).

    3.  **Хранение (Database Integrity):**
        - В DTO регистрации/обновления передается только `key` (путь к файлу в бакете).
        - В базе данных хранятся **относительные пути** (например, `avatars/uuid.webp`).
        - _Причина:_ Полные URL могут измениться при смене домена или CDN.

    4.  **Очистка (Lifecycle Management):**
        - (В перспективе) Неиспользуемые файлы в S3 удаляются через Lifecycle Policies или Cron-задачи.

- **Consequences:**
    - **Positive:**
        - Высокая масштабируемость: сервер не тратит ресурсы на обработку медиа.
        - Снижение задержек (Latency): файл летит напрямую в ближайшую точку S3.
        - Чистый API: контроллеры работают только с JSON.
    - **Negative:**
        - Доверие к клиенту в вопросе качества сжатия (частично нивелируется проверками S3 на размер и тип).
        - Необходимость настройки CORS на стороне S3 провайдера.

- **Compliance:**
    - Запрещено создавать эндпоинты, принимающие `multipart/form-data` для изображений без веской причины.
    - Все пути в БД должны быть нормализованы (без протокола и домена).
